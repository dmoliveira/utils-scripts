#!/usr/bin/env bash
set -euo pipefail

timestamp=$(date +"%Y%m%d%H%M%S")
ARCH=$(uname -m)
DRY_RUN=false

usage() {
  cat <<'EOF'
Usage: install_my_programs_mac [options]

Options:
  --dry-run   Print planned actions without changing the system
  -h, --help  Show this help message
EOF
}

parse_args() {
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --dry-run)
        DRY_RUN=true
        ;;
      -h|--help)
        usage
        exit 0
        ;;
      *)
        echo "Unknown option: $1" >&2
        usage >&2
        exit 1
        ;;
    esac
    shift
  done
}

run_cmd() {
  if [[ "$DRY_RUN" == "true" ]]; then
    printf '[dry-run] %s\n' "$*"
    return 0
  fi
  "$@"
}

install_optional_brew_formula() {
  local formula="$1"
  local label="${2:-$1}"

  if [[ "$DRY_RUN" == "true" ]]; then
    run_cmd brew install "$formula"
    return
  fi

  if ! brew info "$formula" >/dev/null 2>&1; then
    echo "‚ÑπÔ∏è ${label} unavailable in current Homebrew taps; skipping"
    return
  fi

  if brew list "$formula" &>/dev/null; then
    echo "‚úÖ ${label} already installed"
    return
  fi

  brew install "$formula"
  echo "‚úÖ Installed ${label}"
}

install_monitoring_stack() {
  echo "Installing terminal monitoring tools..."
  install_optional_brew_formula bottom "bottom (btm)"

  if [[ "$ARCH" == "arm64" ]]; then
    install_optional_brew_formula asitop "asitop"
  fi

  echo "‚ÑπÔ∏è nvtop is skipped on macOS; use 'bottom' (btm) and Activity Monitor alternatives"
}

install_productivity_cli_stack() {
  echo "Installing advanced productivity CLI tools..."
  install_optional_brew_formula lazygit
  install_optional_brew_formula hyperfine
  install_optional_brew_formula dua-cli "dua-cli (dua)"
  install_optional_brew_formula dust
  install_optional_brew_formula procs
  install_optional_brew_formula xh
  install_optional_brew_formula doggo
  install_optional_brew_formula watchexec
  install_optional_brew_formula kubectl
  install_optional_brew_formula k9s
  install_optional_brew_formula trivy
  install_optional_brew_formula zellij
}

parse_args "$@"

# üß© Install Homebrew if not already installed
if ! command -v brew &>/dev/null; then
  echo "Installing Homebrew..."
  if [[ "$DRY_RUN" == "true" ]]; then
    printf '[dry-run] /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"\n'
  else
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  fi
fi

echo "Updating Homebrew..."
run_cmd brew update
run_cmd brew upgrade

# üß∞ Core developer tools
run_cmd brew install \
  wget htop btop tmux neovim curl git jq tree \
  fzf zoxide ripgrep bat fd gh \
  direnv atuin \
  python uv

install_monitoring_stack
install_productivity_cli_stack

if ! brew list --cask ghostty &>/dev/null; then
  run_cmd brew install --cask ghostty
fi

# üß† AI/ML environment (optional)
run_cmd brew install \
  cmake openblas lapack gfortran \
  protobuf rust

# üêö Zsh terminal enhancements
run_cmd brew install starship zsh zsh-autosuggestions zsh-syntax-highlighting

# üß© Fonts (optional)
run_cmd brew install --cask font-fira-code-nerd-font

if [[ -f "./run_commands/my_ghostty_config" ]]; then
  run_cmd mkdir -p "$HOME/.config/ghostty"
  if [[ -f "$HOME/.config/ghostty/config" ]]; then
    run_cmd cp "$HOME/.config/ghostty/config" "$HOME/.config/ghostty/config.${timestamp}.bak"
  fi
  run_cmd cp -f "./run_commands/my_ghostty_config" "$HOME/.config/ghostty/config"
  echo "‚úÖ Installed Ghostty config to ~/.config/ghostty/config"
fi

if [[ -f "./run_commands/secrets_shell.env.example" ]]; then
  run_cmd mkdir -p "$HOME/.config/secrets"
  if [[ ! -f "$HOME/.config/secrets/shell.env" ]]; then
    run_cmd cp -f "./run_commands/secrets_shell.env.example" "$HOME/.config/secrets/shell.env"
    run_cmd chmod 600 "$HOME/.config/secrets/shell.env"
    echo "‚úÖ Installed $HOME/.config/secrets/shell.env (edit with your local secrets)"
  fi
fi

# üßÆ Lua / auxiliary tools (optional)
run_cmd brew install luarocks

echo "‚úÖ Setup complete! Recommended next steps:"
echo "- Run: 'chsh -s $(which zsh)' to make Zsh your default shell"
echo "- Run: 'eval \"\$(starship init zsh)\"' to enable Starship prompt"
