#!/usr/bin/env bash
set -euo pipefail

timestamp=$(date +"%Y%m%d%H%M%S")
ARCH=$(uname -m)

install_optional_brew_formula() {
  local formula="$1"
  local label="${2:-$1}"

  if ! brew info "$formula" >/dev/null 2>&1; then
    echo "‚ÑπÔ∏è ${label} unavailable in current Homebrew taps; skipping"
    return
  fi

  if brew list "$formula" &>/dev/null; then
    echo "‚úÖ ${label} already installed"
    return
  fi

  brew install "$formula"
  echo "‚úÖ Installed ${label}"
}

install_monitoring_stack() {
  echo "Installing terminal monitoring tools..."
  install_optional_brew_formula bottom "bottom (btm)"

  if [[ "$ARCH" == "arm64" ]]; then
    install_optional_brew_formula asitop "asitop"
  fi

  echo "‚ÑπÔ∏è nvtop is skipped on macOS; use 'bottom' (btm) and Activity Monitor alternatives"
}

install_productivity_cli_stack() {
  echo "Installing advanced productivity CLI tools..."
  install_optional_brew_formula lazygit
  install_optional_brew_formula hyperfine
  install_optional_brew_formula dua-cli "dua-cli (dua)"
  install_optional_brew_formula dust
  install_optional_brew_formula procs
  install_optional_brew_formula xh
  install_optional_brew_formula doggo
  install_optional_brew_formula watchexec
  install_optional_brew_formula kubectl
  install_optional_brew_formula k9s
  install_optional_brew_formula trivy
  install_optional_brew_formula zellij
}

# üß© Install Homebrew if not already installed
if ! command -v brew &>/dev/null; then
  echo "Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

echo "Updating Homebrew..."
brew update && brew upgrade

# üß∞ Core developer tools
brew install \
  wget htop btop tmux neovim curl git jq tree \
  fzf zoxide ripgrep bat fd gh \
  direnv atuin \
  python uv

install_monitoring_stack
install_productivity_cli_stack

if ! brew list --cask ghostty &>/dev/null; then
  brew install --cask ghostty
fi

# üß† AI/ML environment (optional)
brew install \
  cmake openblas lapack gfortran \
  protobuf rust

# üêö Zsh terminal enhancements
brew install starship zsh zsh-autosuggestions zsh-syntax-highlighting

# üß© Fonts (optional)
brew install --cask font-fira-code-nerd-font

if [[ -f "./run_commands/my_ghostty_config" ]]; then
  mkdir -p "$HOME/.config/ghostty"
  if [[ -f "$HOME/.config/ghostty/config" ]]; then
    cp "$HOME/.config/ghostty/config" "$HOME/.config/ghostty/config.${timestamp}.bak"
  fi
  cp -f "./run_commands/my_ghostty_config" "$HOME/.config/ghostty/config"
  echo "‚úÖ Installed Ghostty config to ~/.config/ghostty/config"
fi

if [[ -f "./run_commands/secrets_shell.env.example" ]]; then
  mkdir -p "$HOME/.config/secrets"
  if [[ ! -f "$HOME/.config/secrets/shell.env" ]]; then
    cp -f "./run_commands/secrets_shell.env.example" "$HOME/.config/secrets/shell.env"
    chmod 600 "$HOME/.config/secrets/shell.env"
    echo "‚úÖ Installed $HOME/.config/secrets/shell.env (edit with your local secrets)"
  fi
fi

# üßÆ Lua / auxiliary tools (optional)
brew install luarocks

echo "‚úÖ Setup complete! Recommended next steps:"
echo "- Run: 'chsh -s $(which zsh)' to make Zsh your default shell"
echo "- Run: 'eval \"\$(starship init zsh)\"' to enable Starship prompt"
