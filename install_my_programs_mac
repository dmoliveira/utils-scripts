#!/usr/bin/env bash
set -euo pipefail

timestamp=$(date +"%Y%m%d%H%M%S")

# üß© Install Homebrew if not already installed
if ! command -v brew &>/dev/null; then
  echo "Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

echo "Updating Homebrew..."
brew update && brew upgrade

# üß∞ Core developer tools
brew install \
  wget htop tmux neovim curl git jq tree \
  fzf zoxide ripgrep bat fd gh \
  direnv atuin \
  python uv

if ! brew list --cask ghostty &>/dev/null; then
  brew install --cask ghostty
fi

# üß† AI/ML environment (optional)
brew install \
  cmake openblas lapack gfortran \
  protobuf rust

# üêö Zsh terminal enhancements
brew install starship zsh zsh-autosuggestions zsh-syntax-highlighting

# üß© Fonts (optional)
brew install --cask font-fira-code-nerd-font

if [[ -f "./run_commands/my_ghostty_config" ]]; then
  mkdir -p "$HOME/.config/ghostty"
  if [[ -f "$HOME/.config/ghostty/config" ]]; then
    cp "$HOME/.config/ghostty/config" "$HOME/.config/ghostty/config.${timestamp}.bak"
  fi
  cp -f "./run_commands/my_ghostty_config" "$HOME/.config/ghostty/config"
  echo "‚úÖ Installed Ghostty config to ~/.config/ghostty/config"
fi

if [[ -f "./run_commands/secrets_shell.env.example" ]]; then
  mkdir -p "$HOME/.config/secrets"
  if [[ ! -f "$HOME/.config/secrets/shell.env" ]]; then
    cp -f "./run_commands/secrets_shell.env.example" "$HOME/.config/secrets/shell.env"
    chmod 600 "$HOME/.config/secrets/shell.env"
    echo "‚úÖ Installed $HOME/.config/secrets/shell.env (edit with your local secrets)"
  fi
fi

# üßÆ Lua / auxiliary tools (optional)
brew install luarocks

echo "‚úÖ Setup complete! Recommended next steps:"
echo "- Run: 'chsh -s $(which zsh)' to make Zsh your default shell"
echo "- Run: 'eval \"\$(starship init zsh)\"' to enable Starship prompt"
