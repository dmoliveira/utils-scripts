#!/usr/bin/env bash

set -euo pipefail

# ------------------------------------------------------------------------------
# Title: Install My Unix Programs (2025 Edition)
# Description: Unified setup script for macOS and Debian/Ubuntu AI/ML environments.
# Author: Diego Oliveira
# ------------------------------------------------------------------------------

# === Global setup =============================================================
timestamp=$(date +"%Y%m%d%H%M%S")
OS=$(uname -s)
ARCH=$(uname -m)
echo "üß† Detected OS: $OS"
echo "üß¨ Detected ARCH: $ARCH"
INSTALL_ML_LIBS=true
INSTALL_FONTS=true

usage() {
  cat <<'EOF'
Usage: install_my_programs_unix [options]

Options:
  --skip-ml       Skip installing AI/ML Python packages
  --skip-fonts    Skip installing fonts
  -h, --help      Show this help message
EOF
}

parse_args() {
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --skip-ml)
        INSTALL_ML_LIBS=false
        ;;
      --skip-fonts)
        INSTALL_FONTS=false
        ;;
      -h|--help)
        usage
        exit 0
        ;;
      *)
        echo "Unknown option: $1" >&2
        usage
        exit 1
        ;;
    esac
    shift
  done
}

# ------------------------------------------------------------------------------
# üß© Utility functions
# ------------------------------------------------------------------------------

backup_file() {
  local file="$1"
  if [[ -f "$file" ]]; then
    local backup="${file}.${timestamp}.bak"
    cp "$file" "$backup"
    echo "üì¶ Backed up $file ‚Üí $backup"
  fi
}

install_pkg() {
  local pkg="$1"
  if [[ "$OS" == "Darwin" ]]; then
    brew list "$pkg" &>/dev/null || brew install "$pkg"
  else
    dpkg -s "$pkg" &>/dev/null || sudo apt install -y "$pkg"
  fi
}

install_optional_brew_formula() {
  local formula="$1"
  local label="${2:-$1}"

  if ! brew info "$formula" >/dev/null 2>&1; then
    echo "‚ÑπÔ∏è ${label} unavailable in current Homebrew taps; skipping"
    return
  fi

  if brew list "$formula" &>/dev/null; then
    echo "‚úÖ ${label} already installed"
    return
  fi

  brew install "$formula"
  echo "‚úÖ Installed ${label}"
}

install_apt_first_available() {
  local label="$1"
  shift

  local pkg
  for pkg in "$@"; do
    if apt-cache show "$pkg" >/dev/null 2>&1; then
      if dpkg -s "$pkg" >/dev/null 2>&1; then
        echo "‚úÖ ${label} already installed (${pkg})"
      else
        sudo apt install -y "$pkg"
        echo "‚úÖ Installed ${label} (${pkg})"
      fi
      return
    fi
  done

  echo "‚ÑπÔ∏è ${label} unavailable in configured apt repositories; skipping"
}

has_linux_gpu() {
  if command -v nvidia-smi >/dev/null 2>&1; then
    return 0
  fi

  if [[ -e "/dev/dri" ]]; then
    return 0
  fi

  return 1
}

install_brew() {
  if ! command -v brew &>/dev/null; then
    echo "üç∫ Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  fi
}

install_ohmyzsh() {
  if [[ ! -d "$HOME/.oh-my-zsh" ]]; then
    echo "üí´ Installing Oh-My-Zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
  fi
}

clone_if_missing() {
  local repo="$1"
  local dest="$2"
  if [[ ! -d "$dest" ]]; then
    echo "üîó Cloning $repo ‚Üí $dest"
    git clone --depth=1 "$repo" "$dest"
  fi
}

safe_copy() {
  local src="$1"
  local dest="$2"
  if [[ -f "$src" ]]; then
    mkdir -p "$(dirname "$dest")"
    cp -f "$src" "$dest"
    echo "üìù Installed $src ‚Üí $dest"
  fi
}

install_local_bin_script() {
  local src="$1"
  local dest_dir="$HOME/.local/bin"
  local dest="$dest_dir/$(basename "$src")"
  if [[ -f "$src" ]]; then
    mkdir -p "$dest_dir"
    cp -f "$src" "$dest"
    chmod +x "$dest"
    echo "üß∞ Installed $(basename "$src") ‚Üí $dest"
  fi
}

# ------------------------------------------------------------------------------
# üß∞ 1. System base setup
# ------------------------------------------------------------------------------

setup_system() {
  echo "‚öôÔ∏è Setting up system base packages..."
  if [[ "$OS" == "Darwin" ]]; then
    install_brew
    brew update && brew upgrade
    brew install git curl wget neovim tmux htop btop bottom tree jq fzf zoxide ripgrep bat fd gh cmake python uv direnv atuin
  else
    sudo apt update -y && sudo apt upgrade -y
    sudo apt install -y curl wget git neovim tmux htop btop tree jq fzf zoxide ripgrep bat fd-find cmake python3 python3-pip python3-venv python3-dev direnv
  fi
}

setup_monitoring() {
  echo "üìà Configuring monitoring stack..."

  if [[ "$OS" == "Darwin" ]]; then
    if [[ "$ARCH" == "arm64" ]]; then
      if brew info asitop >/dev/null 2>&1; then
        brew list asitop &>/dev/null || brew install asitop
        echo "‚úÖ asitop installed for Apple Silicon"
      else
        echo "‚ÑπÔ∏è asitop formula unavailable in current taps; skipping"
      fi
    fi

    echo "‚ÑπÔ∏è nvtop skipped on macOS"
    return
  fi

  if has_linux_gpu; then
    if apt-cache show nvtop >/dev/null 2>&1; then
      sudo apt install -y nvtop
      echo "‚úÖ nvtop installed (Linux GPU detected)"
    else
      echo "‚ÑπÔ∏è nvtop package not available in configured apt repositories"
    fi
  else
    echo "‚ÑπÔ∏è No GPU device detected; nvtop skipped"
  fi
}

install_productivity_cli_stack() {
  echo "üß∞ Installing advanced productivity CLI tools..."

  if [[ "$OS" == "Darwin" ]]; then
    install_optional_brew_formula lazygit
    install_optional_brew_formula hyperfine
    install_optional_brew_formula dua-cli "dua-cli (dua)"
    install_optional_brew_formula dust
    install_optional_brew_formula procs
    install_optional_brew_formula xh
    install_optional_brew_formula doggo
    install_optional_brew_formula watchexec
    install_optional_brew_formula kubectl
    install_optional_brew_formula k9s
    install_optional_brew_formula trivy
    install_optional_brew_formula zellij
    return
  fi

  install_apt_first_available lazygit lazygit
  install_apt_first_available hyperfine hyperfine
  install_apt_first_available "dua-cli (dua)" dua-cli
  install_apt_first_available dust du-dust dust
  install_apt_first_available procs procs
  install_apt_first_available xh xh
  install_apt_first_available doggo doggo
  install_apt_first_available watchexec watchexec
  install_apt_first_available kubectl kubectl kubernetes-client
  install_apt_first_available k9s k9s
  install_apt_first_available trivy trivy
  install_apt_first_available zellij zellij
}

# ------------------------------------------------------------------------------
# üß† 2. Python setup
# ------------------------------------------------------------------------------

setup_python() {
  echo "üêç Installing Python packages..."
  python3 -m ensurepip --upgrade || true
  python3 -m pip install -U pip wheel setuptools
  if [[ -f "./requirements.txt" ]]; then
    python3 -m pip install -r ./requirements.txt
  fi
}

# ------------------------------------------------------------------------------
# üí´ 3. Shell setup (Zsh, Oh-My-Zsh, Starship)
# ------------------------------------------------------------------------------

setup_shell() {
  echo "üí´ Configuring shell..."
  install_ohmyzsh

  if [[ "$OS" == "Darwin" ]]; then
    brew install starship atuin
  else
    curl -sS https://starship.rs/install.sh | sh -s -- -y
    if ! command -v atuin &>/dev/null; then
      if command -v cargo &>/dev/null; then
        cargo install atuin --locked || true
      else
        echo "‚ö†Ô∏è Atuin not installed (cargo missing). Install Rust/cargo and run: cargo install atuin --locked"
      fi
    fi
  fi

  # Backup and replace configs
  for file in "$HOME/.bashrc" "$HOME/.zshrc"; do
    backup_file "$file"
  done

  # Copy new configs
  safe_copy "./run_commands/my_bashrc" "$HOME/.bashrc"
  safe_copy "./run_commands/my_zshrc" "$HOME/.zshrc"

  # Source custom files if preferred style
  for shell_file in bashrc zshrc; do
    target="$HOME/.${shell_file}"
    myfile="$HOME/.my_${shell_file}"
    [[ -f "./run_commands/my_${shell_file}" ]] && cp "./run_commands/my_${shell_file}" "$myfile"
    if ! grep -q "source ~/.my_${shell_file}" "$target" 2>/dev/null; then
      echo "source ~/.my_${shell_file}" >> "$target"
      echo "ü™Ñ Added sourcing line to $target"
    fi
  done

  if [[ -f "./run_commands/secrets_shell.env.example" ]]; then
    mkdir -p "$HOME/.config/secrets"
    if [[ ! -f "$HOME/.config/secrets/shell.env" ]]; then
      cp -f "./run_commands/secrets_shell.env.example" "$HOME/.config/secrets/shell.env"
      chmod 600 "$HOME/.config/secrets/shell.env"
      echo "‚úÖ Installed $HOME/.config/secrets/shell.env (edit with your local secrets)"
    fi
  fi
}

# ------------------------------------------------------------------------------
# ü™∂ 4. NeoVim + Lazy.nvim
# ------------------------------------------------------------------------------

setup_neovim() {
  echo "ü™∂ Setting up NeoVim..."
  clone_if_missing "https://github.com/folke/lazy.nvim.git" "$HOME/.local/share/nvim/lazy/lazy.nvim"
  mkdir -p "$HOME/.config/nvim"
  mkdir -p "$HOME/.config/nvim/lua/utils_scripts"
  backup_file "$HOME/.config/nvim/init.lua"
  safe_copy "./run_commands/my_nvim_init.lua" "$HOME/.config/nvim/init.lua"
  for module in plugins options keymaps lsp ui; do
    safe_copy "./run_commands/nvim/lua/utils_scripts/${module}.lua" "$HOME/.config/nvim/lua/utils_scripts/${module}.lua"
  done
}

# ------------------------------------------------------------------------------
# üß© 5. Fonts (Nerd Font / Fira Code)
# ------------------------------------------------------------------------------

setup_fonts() {
  echo "üî§ Installing fonts..."
  if [[ "$OS" == "Darwin" ]]; then
    brew install --cask font-fira-code-nerd-font
  else
    mkdir -p ~/.local/share/fonts
    wget -q https://github.com/ryanoasis/nerd-fonts/releases/latest/download/FiraCode.zip -O /tmp/FiraCode.zip
    unzip -o /tmp/FiraCode.zip -d ~/.local/share/fonts >/dev/null
    fc-cache -fv >/dev/null
  fi
}

# ------------------------------------------------------------------------------
# üß© 6. Tmux + TPM
# ------------------------------------------------------------------------------

setup_tmux() {
  echo "üß© Installing Tmux plugin manager..."
  clone_if_missing "https://github.com/tmux-plugins/tpm" "$HOME/.tmux/plugins/tpm"
  backup_file "$HOME/.tmux.conf"
  safe_copy "./run_commands/my_tmux.conf" "$HOME/.tmux.conf"
}

# ------------------------------------------------------------------------------
# üß© 7. Ghostty (macOS)
# ------------------------------------------------------------------------------

setup_ghostty() {
  if [[ "$OS" != "Darwin" ]]; then
    echo "üß© Ghostty setup skipped on non-macOS."
    return
  fi

  echo "üß© Installing Ghostty and config..."
  if ! brew list --cask ghostty &>/dev/null; then
    brew install --cask ghostty
  fi
  mkdir -p "$HOME/.config/ghostty"
  backup_file "$HOME/.config/ghostty/config"
  safe_copy "./run_commands/my_ghostty_config" "$HOME/.config/ghostty/config"
}

# ------------------------------------------------------------------------------
# ü§ñ 8. AI/ML libraries (optional)
# ------------------------------------------------------------------------------

install_ml_libs() {
  echo "üß† Installing AI/ML Python packages..."
  python3 -m pip install -U numpy pandas scikit-learn jupyterlab matplotlib seaborn \
    torch torchvision torchaudio xgboost lightgbm transformers sentence-transformers \
    openai optuna mlflow
}

# ------------------------------------------------------------------------------
# üìé 9. Local helper scripts
# ------------------------------------------------------------------------------

install_local_scripts() {
  echo "üìé Installing local helper scripts..."
  install_local_bin_script "./bootstrap_shell_secrets"
  install_local_bin_script "./bd_init_project"
  install_local_bin_script "./codex_apply_config"
  install_local_bin_script "./repomix_generate"
}

# ------------------------------------------------------------------------------
# üìø 10. Beads (bd)
# ------------------------------------------------------------------------------

install_beads() {
  echo "üìø Installing Beads (bd)..."
  if command -v bd &>/dev/null; then
    echo "‚úÖ bd already installed. Skipping."
    return
  fi
  curl -fsSL https://raw.githubusercontent.com/steveyegge/beads/main/scripts/install.sh | bash
}

# ------------------------------------------------------------------------------
# ü§ñ 11. Codex config
# ------------------------------------------------------------------------------

install_codex_config() {
  echo "ü§ñ Configuring Codex..."
  mkdir -p "$HOME/.codex"
  safe_copy "./run_commands/codex_config.toml" "$HOME/.codex/config.template.toml"
  if [[ -x "$HOME/.local/bin/codex_apply_config" ]]; then
    "$HOME/.local/bin/codex_apply_config"
  else
    echo "‚ö†Ô∏è codex_apply_config not installed; skipping config apply."
  fi
}

# ------------------------------------------------------------------------------
# üöÄ Run all setup steps
# ------------------------------------------------------------------------------

main() {
  parse_args "$@"
  setup_system
  setup_monitoring
  install_productivity_cli_stack
  install_beads
  install_local_scripts
  install_codex_config
  setup_python
  setup_shell
  setup_neovim
  setup_ghostty
  if [[ "$INSTALL_FONTS" == "true" ]]; then
    setup_fonts
  else
    echo "üî§ Skipping fonts install."
  fi
  setup_tmux
  if [[ "$INSTALL_ML_LIBS" == "true" ]]; then
    install_ml_libs
  else
    echo "üß† Skipping AI/ML Python packages."
  fi
  echo "‚úÖ All done! Restart your terminal to apply changes."
  echo "üí° Tip: Add 'eval \"\$(starship init zsh)\"' to ~/.zshrc"
}

main "$@"
