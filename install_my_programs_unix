#!/usr/bin/env bash

set -euo pipefail

# ------------------------------------------------------------------------------
# Title: Install My Unix Programs (2025 Edition)
# Description: Unified setup script for macOS and Debian/Ubuntu AI/ML environments.
# Author: Diego Oliveira
# ------------------------------------------------------------------------------

# === Global setup =============================================================
timestamp=$(date +"%Y%m%d%H%M%S")
OS=$(uname -s)
echo "ðŸ§  Detected OS: $OS"

# ------------------------------------------------------------------------------
# ðŸ§© Utility functions
# ------------------------------------------------------------------------------

backup_file() {
  local file="$1"
  if [[ -f "$file" ]]; then
    local backup="${file}.${timestamp}.bak"
    cp "$file" "$backup"
    echo "ðŸ“¦ Backed up $file â†’ $backup"
  fi
}

install_pkg() {
  local pkg="$1"
  if [[ "$OS" == "Darwin" ]]; then
    brew list "$pkg" &>/dev/null || brew install "$pkg"
  else
    dpkg -s "$pkg" &>/dev/null || sudo apt install -y "$pkg"
  fi
}

install_brew() {
  if ! command -v brew &>/dev/null; then
    echo "ðŸº Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  fi
}

install_ohmyzsh() {
  if [[ ! -d "$HOME/.oh-my-zsh" ]]; then
    echo "ðŸ’« Installing Oh-My-Zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
  fi
}

clone_if_missing() {
  local repo="$1"
  local dest="$2"
  if [[ ! -d "$dest" ]]; then
    echo "ðŸ”— Cloning $repo â†’ $dest"
    git clone --depth=1 "$repo" "$dest"
  fi
}

safe_copy() {
  local src="$1"
  local dest="$2"
  if [[ -f "$src" ]]; then
    mkdir -p "$(dirname "$dest")"
    cp -f "$src" "$dest"
    echo "ðŸ“ Installed $src â†’ $dest"
  fi
}

# ------------------------------------------------------------------------------
# ðŸ§° 1. System base setup
# ------------------------------------------------------------------------------

setup_system() {
  echo "âš™ï¸ Setting up system base packages..."
  if [[ "$OS" == "Darwin" ]]; then
    install_brew
    brew update && brew upgrade
    brew install git curl wget neovim tmux htop tree jq fzf zoxide ripgrep bat fd gh cmake python uv
  else
    sudo apt update -y && sudo apt upgrade -y
    sudo apt install -y curl wget git neovim tmux htop tree jq fzf zoxide ripgrep bat fd-find cmake python3 python3-pip python3-venv python3-dev
  fi
}

# ------------------------------------------------------------------------------
# ðŸ§  2. Python setup
# ------------------------------------------------------------------------------

setup_python() {
  echo "ðŸ Installing Python packages..."
  python3 -m ensurepip --upgrade || true
  pip install -U pip wheel setuptools
  if [[ -f "./requirements.txt" ]]; then
    pip install -r ./requirements.txt
  fi
}

# ------------------------------------------------------------------------------
# ðŸ’« 3. Shell setup (Zsh, Oh-My-Zsh, Starship)
# ------------------------------------------------------------------------------

setup_shell() {
  echo "ðŸ’« Configuring shell..."
  install_ohmyzsh

  if [[ "$OS" == "Darwin" ]]; then
    brew install starship
  else
    curl -sS https://starship.rs/install.sh | sh -s -- -y
  fi

  # Backup and replace configs
  for file in "$HOME/.bashrc" "$HOME/.zshrc"; do
    backup_file "$file"
  done

  # Copy new configs
  safe_copy "./run_commands/my_bashrc" "$HOME/.bashrc"
  safe_copy "./run_commands/my_zshrc" "$HOME/.zshrc"

  # Source custom files if preferred style
  for shell_file in bashrc zshrc; do
    target="$HOME/.${shell_file}"
    myfile="$HOME/.my_${shell_file}"
    [[ -f "./run_commands/my_${shell_file}" ]] && cp "./run_commands/my_${shell_file}" "$myfile"
    if ! grep -q "source ~/.my_${shell_file}" "$target" 2>/dev/null; then
      echo "source ~/.my_${shell_file}" >> "$target"
      echo "ðŸª„ Added sourcing line to $target"
    fi
  done
}

# ------------------------------------------------------------------------------
# ðŸª¶ 4. NeoVim + Lazy.nvim
# ------------------------------------------------------------------------------

setup_neovim() {
  echo "ðŸª¶ Setting up NeoVim..."
  clone_if_missing "https://github.com/folke/lazy.nvim.git" "$HOME/.local/share/nvim/lazy/lazy.nvim"
  mkdir -p "$HOME/.config/nvim"
  backup_file "$HOME/.config/nvim/init.lua"
  safe_copy "./run_commands/my_nvim_init.lua" "$HOME/.config/nvim/init.lua"
}

# ------------------------------------------------------------------------------
# ðŸ§© 5. Fonts (Nerd Font / Fira Code)
# ------------------------------------------------------------------------------

setup_fonts() {
  echo "ðŸ”¤ Installing fonts..."
  if [[ "$OS" == "Darwin" ]]; then
    brew install --cask font-fira-code-nerd-font
  else
    mkdir -p ~/.local/share/fonts
    wget -q https://github.com/ryanoasis/nerd-fonts/releases/latest/download/FiraCode.zip -O /tmp/FiraCode.zip
    unzip -o /tmp/FiraCode.zip -d ~/.local/share/fonts >/dev/null
    fc-cache -fv >/dev/null
  fi
}

# ------------------------------------------------------------------------------
# ðŸ§© 6. Tmux + TPM
# ------------------------------------------------------------------------------

setup_tmux() {
  echo "ðŸ§© Installing Tmux plugin manager..."
  clone_if_missing "https://github.com/tmux-plugins/tpm" "$HOME/.tmux/plugins/tpm"
  backup_file "$HOME/.tmux.conf"
  safe_copy "./run_commands/my_tmux.conf" "$HOME/.tmux.conf"
}

# ------------------------------------------------------------------------------
# ðŸ¤– 7. AI/ML libraries (optional)
# ------------------------------------------------------------------------------

install_ml_libs() {
  echo "ðŸ§  Installing AI/ML Python packages..."
  pip install -U numpy pandas scikit-learn jupyterlab matplotlib seaborn \
    torch torchvision torchaudio xgboost lightgbm transformers sentence-transformers \
    openai optuna mlflow
}

# ------------------------------------------------------------------------------
# ðŸš€ Run all setup steps
# ------------------------------------------------------------------------------

main() {
  setup_system
  setup_python
  setup_shell
  setup_neovim
  setup_fonts
  setup_tmux
  install_ml_libs
  echo "âœ… All done! Restart your terminal to apply changes."
  echo "ðŸ’¡ Tip: Add 'eval \"\$(starship init zsh)\"' to ~/.zshrc"
}

main "$@"
